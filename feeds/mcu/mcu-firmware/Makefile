#
# Copyright (C) 2023 OpenWrt.org
#
# This is free software, licensed under the GNU General Public License v2.
# See /LICENSE for more information.
#

include $(TOPDIR)/rules.mk

PKG_NAME:=mcu-firmware
PKG_VERSION:=2024-04-02
PKG_RELEASE:=1

PKG_MAINTAINER:=Piotr Dymacz <pepe2k@gmail.com>

include $(INCLUDE_DIR)/package.mk

define Package/mcu-fw-default
  CATEGORY:=Firmware
  SUBMENU:=MCU firmware
  SECTION:=firmware
  TITLE:=MCU firmware
endef

comma := ,
word-comma = $(word $2,$(subst $(comma), ,$1))
word-underscore = $(word $2,$(subst _, ,$1))

# List of MCU firmware packages generated by CI
# 4 fields separated with single underscore:
#   version-name_git-sha_ci-job-id_sha256-of-package
NORDIC_VERSIONS := \
	ncs-main_fbc18f5c86e7_6531918751_ce4d126c2a89d1ab6775351b072d4623858b8aa99fdfeb5eef0ca8cb396a647b

OT_CC26X2_VERSIONS := \
	openthread-cc26x2-main_26c40426b6d9_6531919804_e1cb804f77cbc7a30d8af5aec09ba4d34e47ac7f628a60e302780ba1315f8e12

OT_NRF528XX_VERSIONS := \
	openthread-nrf528xx-main_ab63c6fa45c7_6531920628_a92ca5073acf216947fe5fd12bf130e037bf6508a5fcb50905efea1f45a4f41f

ZEPHYR_VERSIONS := \
	zephyr-v3.3.x_7055d10e538e_3877473859_321a0daf6328698a913c6504d19aa85a5170dfce6039b86d31d2e9162d34af7c \
	zephyr-v3.5.x_2335d0181cd3_6531911906_147c4d5f4fdf0b700bf7e03341776fac9bba3aaf62f8d2ba64229dd82951a119 \
	zephyr-v3.6.x_37aeaac10e7a_6531912952_c52c376f253fcf60e5abcc38a55061cb4307dfd2dbbc81d7d2d9803d0a8ae28d \
	zephyr-main_772645bb8b5f_6531917148_c678402828732507dc303c68a2131cf1dfccc71330b9cbb3c00b307965381199

NORDIC_FW_CI_URL := https://gitlab.com/pepe2k/nrfconnect-sdk-nrf/-/jobs/
OT_CC26X2_FW_CI_URL := https://gitlab.com/pepe2k/openthread-cc13x2-cc26x2/-/jobs/
OT_NRF528XX_FW_CI_URL := https://gitlab.com/pepe2k/openthread-nrf528xx/-/jobs/
ZEPHYR_FW_CI_URL := https://gitlab.com/pepe2k/zephyr/-/jobs/

MCU_FW_NAMES := \
	hello_world \
	hci_uart \
	hci_usb \
	mcuboot \
	ot-cli-ftd \
	ot-cli-mtd \
	ot-cli-radio \
	ot-ncp-ftd \
	ot-ncp-mtd \
	ot-rcp


# MCU firmware package download
# - $(2): firmware package version string
# - $(3): firmware package CI download URL
define Download/mcu-fw
  URL:=$(3)$(call word-underscore,$(2),3)/
  URL_FILE:=artifacts/download?file_type=archive
  FILE:=$(call word-underscore,$(2),1)-$(call word-underscore,$(2),2).zip
  HASH:=$(call word-underscore,$(2),4)
endef

$(foreach FW,$(NORDIC_VERSIONS),$(eval $(call Download,mcu-fw,$(FW),$(NORDIC_FW_CI_URL))))
$(foreach FW,$(OT_CC26X2_VERSIONS),$(eval $(call Download,mcu-fw,$(FW),$(OT_CC26X2_FW_CI_URL))))
$(foreach FW,$(OT_NRF528XX_VERSIONS),$(eval $(call Download,mcu-fw,$(FW),$(OT_NRF528XX_FW_CI_URL))))
$(foreach FW,$(ZEPHYR_VERSIONS),$(eval $(call Download,mcu-fw,$(FW),$(ZEPHYR_FW_CI_URL))))


# MCU firmware package extract
# - $(1): firmware package version string
# - $(2): firmware package CI download URL
define mcu-fw-unzip
	mkdir -p $(PKG_BUILD_DIR)/$(call word-underscore,$(1),1); \
	unzip -q -d $(PKG_BUILD_DIR)/$(call word-underscore,$(1),1) \
	  $(DL_DIR)/$(call word-underscore,$(1),1)-$(call word-underscore,$(1),2).zip; \
	for fw in $(PKG_BUILD_DIR)/$(call word-underscore,$(1),1)/*.tar.gz; do \
		$(TAR) -C $(PKG_BUILD_DIR)/$(call word-underscore,$(1),1) --one-top-level -xzf $$$$fw; \
		rm -rf $$$$fw; \
		echo $$$$fw; \
	done;
endef

define Build/Prepare
	$(foreach FW,$(NORDIC_VERSIONS),$(call mcu-fw-unzip,$(FW)))
	$(foreach FW,$(OT_CC26X2_VERSIONS),$(call mcu-fw-unzip,$(FW)))
	$(foreach FW,$(OT_NRF528XX_VERSIONS),$(call mcu-fw-unzip,$(FW)))
	$(foreach FW,$(ZEPHYR_VERSIONS),$(call mcu-fw-unzip,$(FW)))
endef

define Build/Compile
endef


# Host side support packages for MCU firmware name/type
# $(1) firmware name/type (e.g. 'hci_usb')
define mcu-fw-host-support-generate
  define Package/mcu-$(1)-host-support
    $(call Package/mcu-fw-default)
    DEPENDS:=+mcu
    TITLE:=MCU '$(1)' firmware common host side support
    SUBMENU:=
    HIDDEN:=1
  endef

  define Package/mcu-$(1)-host-support/install
	$(CP) ./files/$(1)/* $$(1)/
  endef
endef

# Generate host side support packages (per firmware name/type)
$(foreach FW,$(MCU_FW_NAMES),\
  $(if $(wildcard ./files/$(FW)/*),$(eval $(call mcu-fw-host-support-generate,$(FW)))))
$(foreach FW,$(MCU_FW_NAMES),\
  $(if $(wildcard ./files/$(FW)/*),$(eval $(call BuildPackage,mcu-$(FW)-host-support))))


# $(1) firmware name/type (e.g. 'hci_usb')
define mcu-fw-deps
	$(if $(wildcard ./files/$(1)/*),+mcu-$(1)-host-support) \
	$(if $(findstring hci_u,$1),+bluez-daemon +kmod-bluetooth +kmod-crypto-user)
endef

# $(1) firmware version (e.g 'zephyr-v3.3.x')
define mcu-fw-submenu
	$(if $(findstring ncs-main,$1),nRF Connect SDK dev,\
	$(if $(findstring openthread-cc26x2-main,$1),OpenThread for CC13x2/CC26x2,\
	$(if $(findstring openthread-nrf528xx-main,$1),OpenThread for nRF528xx,\
	$(if $(findstring zephyr-v3.3,$1),Zephyr v3.3,\
	$(if $(findstring zephyr-v3.5,$1),Zephyr v3.5,\
	$(if $(findstring zephyr-v3.6,$1),Zephyr v3.6,\
	$(if $(findstring zephyr-main,$1),Zephyr dev)))))))
endef

# $(1) firmware version (e.g 'zephyr-v3.3.x')
# $(2) firmware name/type (e.g. 'hci_usb')
# $(3) board name firmware is built for (e.g. 'nrf52840dongle_nrf52840')
# $(4) board target name firmware is built for (optional, Zephyr's hwmv2 compat)
define mcu-fw-generate
  define Package/$(1)-$(2)-$(3)
    $(call Package/mcu-fw-default)
    DEPENDS:=+mcu $(call mcu-fw-deps,$(2))
    TITLE:=$(2)
    SUBMENU:=MCU firmware ($(strip $(call mcu-fw-submenu,$(1))))
  endef

  define Package/$(1)-$(2)-$(3)/description
    '$(1)' based firmware '$(2)' for '$(3)' board
  endef

  define Package/$(1)-$(2)-$(3)/install
	$(INSTALL_DIR) $$(1)/lib/firmware/mcu/$(3)/$(1)/$(2)
	$(INSTALL_DATA) $(PKG_BUILD_DIR)/$(1)/$(3)/$(1)__$(2)/*.bin \
		$$(1)/lib/firmware/mcu/$(3)/$(1)/$(2)/
	$(if $(4), $(LN) $(3) $$(1)/lib/firmware/mcu/$(4))
  endef

  MCU_FW_PACKAGES += $(1)-$(2)-$(3)
endef

include nordic.mk
include ot_cc26x2.mk
include ot_nrf528xx.mk
include zephyr.mk

$(foreach MCU_FW_PKG,$(MCU_FW_PACKAGES),\
  $(eval $(call BuildPackage,$(MCU_FW_PKG))))
